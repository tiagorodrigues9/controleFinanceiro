name: Keep Render Awake

on: 
  schedule:
    # A cada 10 minutos, 24 horas por dia (mais frequente para evitar suspensÃ£o)
    - cron: "*/10 * * * *"
  workflow_dispatch:

jobs:
  ping:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps: 
      - name: Request API Health Check
        id: call_api
        env:
          RENDER_URL: ${{ secrets.RENDER_URL || 'https://controle-financeiro-backend1.vercel.app' }}
        run: |
          echo "ðŸ”„ Fazendo ping em: ${RENDER_URL}/health"
          echo "â° Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          
          # Tenta /health primeiro, se falhar tenta /ping
          HTTP_CODE=$(curl -s -o response.txt -w "%{http_code}" --max-time 30 --connect-timeout 10 ${RENDER_URL}/health || echo "000")
          
          # Se /health falhar, tenta /ping como fallback
          if [ "$HTTP_CODE" != "200" ]; then
            echo "âš ï¸  /health falhou, tentando /ping..."
            HTTP_CODE=$(curl -s -o response.txt -w "%{http_code}" --max-time 30 --connect-timeout 10 ${RENDER_URL}/ping || echo "000")
          fi
          
          BODY=$(cat response.txt 2>/dev/null || echo "Erro ao ler resposta")
          TIME_TOTAL=$(curl -s -o /dev/null -w "%{time_total}" --max-time 30 ${RENDER_URL}/health 2>/dev/null || curl -s -o /dev/null -w "%{time_total}" --max-time 30 ${RENDER_URL}/ping 2>/dev/null || echo "0")
          
          # Limpar o BODY para remover caracteres especiais
          BODY=$(echo "$BODY" | tr -d '\n\r\t' | sed 's/"/\\"/g' | head -c 200)
          
          echo "ðŸ“Š Status HTTP: $HTTP_CODE"
          echo "â±ï¸  Tempo de resposta: ${TIME_TOTAL}s"
          echo "ðŸ“„ Resposta: $BODY"
          
          # Verifica se foi bem-sucedido
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Ping bem-sucedido!"
            FULL_RESPONSE="âœ… Sucesso | Status: $HTTP_CODE | Tempo: ${TIME_TOTAL}s | $BODY"
          else
            echo "âŒ Ping falhou com status: $HTTP_CODE"
            FULL_RESPONSE="âŒ Falha | Status: $HTTP_CODE | Tempo: ${TIME_TOTAL}s | $BODY"
            # NÃ£o falha o workflow, apenas registra o erro
            echo "âš ï¸  AplicaÃ§Ã£o pode estar suspensa ou com problemas"
          fi
          
          # Exporta para env
          echo "response=$FULL_RESPONSE" >> $GITHUB_ENV
          echo "http_code=$HTTP_CODE" >> $GITHUB_ENV
